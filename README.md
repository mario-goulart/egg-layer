## egg-layer

**WARNING**: this is a hack.

`egg-layer` is a tool that generate a Makefile to fetch and install
CHICKEN eggs.  Differently from chicken-install, it uses egg sources
from tarballs available at [1].  `egg-layer` relies on external tools
to fetch, verify and unpack tarballs.  The default configuration uses
`wget`, `sha1sum`, `tar` and `gzip` (parameters which use those
commands are configurable -- see `egg-layer-params.scm`).

To generate the dependency graph for Makefile rules, `egg-layer` uses
information from an index file [2] (gzip-compressed).  The format of
that file is:

* The first line is the index format version

* the next lines have the following format:

> (EGG-NAME EGG-VERSION TARBALL-SIZE TARBALL-SHA1-SUM EGG-DEPENDENCIES EGG-TEST-DEPENDENCIES)

`egg-layer` downloads and reads the index file, determines the
dependencies among eggs and tasks (fetch-tarball, fetch-checksum,
unpack, install), and generates the Makefile.

Usage:

```
$ egg-layer -h
Usage: egg-layer [<options>] <egg>

<options>
  --action|-a <action>:
    Action to be executed (default: all).  Available actions:
    * all: install egg.
    * fetch: fetch egg and its dependencies.
    * none: only generate the Makefile.
    * unpack: fetch egg and its dependencies and unpack them.

  --force-dependencies:
    Force processing actions for dependencies.  Without this option,
    actions for dependencies which are already installed will be skipped.

  --keep-output-directory|-k:
    By default, the output directory containing the Makefile generated by
    this program will be removed (unless --output-dir is provided).  With
    this option the the output directory is not removed.

  --output-dir|-o <dir>:
    Output directory (default: temporary directory with a random name)

  --parallel-tasks|-j <number>:
    The value of this parameter maps to the value of the -j parameter
    for make.  If given a negative value, -j for make will be given no
    value.
```

* [1] https://code.call-cc.org/egg-tarballs/
* [2] https://code.call-cc.org/egg-tarballs/5/index.gz


### Why

* Use egg tarballs
  * smaller size
  * integrity verification (HTTPS + checksum)

* Possibility of using the parallel execution feature of make to fetch
  and install eggs


### Bugs, limitations and assorted notes

* It has been very minimally tested on Linux with GNU make.

* No concern regarding portability.

* It uses `chicken-install` as build system for eggs (but not to fetch
  and verify integrity of sources).

* The generated Makefile assumes that `chicken-install` is somewhere
  in `$PATH`.  It doesn't hardcode the full path to the
  `chicken-install` executable in the Makefile (maybe it should).

* It only admits a single egg as argument.

* It completely ignores egg versions.

* It completely ignore egg tests.

* It supports only CHICKEN 5.

* Due to the way `egg-layer` uses `chicken-install`
  (`cd egg-dir && chicken-install`), it ends up not using the
  egg compilation cache.

* Its code is disgusting.

* It is just very rough proof-of-concept.  It is incomplete and
  probably full of bugs.
